<h2 style="margin-bottom: 1em">Example Backend</h2>

<ul class="nav nav-tabs">
    <li class="active"><a class="tab-pane" data-toggle="tab" href="#ssecode">SSE Code</a></li>
    <li><a class="tab-pane" data-toggle="tab" href="#twittercode">Twitter Handling</a></li>
</ul>
<div class="tab-content">
<div id="ssecode" class="tab-pane active">
<pre style="height: 40rem; font-size: 3rem;"><code class="java" style="min-height: 25em">
    def server = vertx.createHttpServer()
    def rm = new RouteMatcher()
    def clients=[]

    rm.get('/stream') { HttpServerRequest req ->
        req.response.statusCode = 200
        req.response.putHeader('Content-Type','text/event-stream')
        req.response.putHeader('Access-Control-Allow-Origin','*')
        req.response.chunked = true

        clients << req.response

        req.response.closeHandler {
            clients.remove(req.response)
        }
    }

    vertx.eventBus.registerHandler('events') { Message msg ->
        def jsonBody = new JsonObject((Map)msg.body())
        def dataString = "data: ${jsonBody.encode()}\n\n"

        clients.each { HttpServerResponse resp ->
            resp.write(dataString)
        }
    }

    server.requestHandler(rm.asClosure()).listen(7001)
</code>
</pre>
</div>
<div id="twittercode" class="tab-pane">
<pre style="height: 40rem; font-size: 3rem;"><code class="java"  style="min-height: 25em">
    final TwitterStream twitterFactory = new TwitterStreamFactory().getInstance();
    def queries = ['spock'];

    final StatusListener statusListener = new StatusAdapter() {
        public void onStatus(Status status) {

            vertx.eventBus.publish('events',[
                type:'twitter',
                data:[
                    'id':status.id,
                    'from':status.user.name,
                    'lang': status.lang,
                    'message':status.text
                ]
            ])
        }
    };

    public void connectTwitterStream(twitter, listener, query) {
        twitter.cleanUp();
        twitter.clearListeners();
        twitter.addListener(listener);
        FilterQuery filterQuery = new FilterQuery();
        filterQuery.track(query as String[]);
        twitter.filter(filterQuery);
    }

    vertx.eventBus.registerHandler('twitter') { Message msg ->
        queries = msg.body()?.query
        connectTwitterStream(twitterFactory,statusListener,queries)
        msg.reply(queries)
    }

    connectTwitterStream(twitterFactory,statusListener,queries)
</code>
</pre>
</div>
</div>
